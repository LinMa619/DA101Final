---
title: "FinalProject_WorldHappinessReport_Group03"
author: "Lin Ma, Zhiyuan Zhang"
date: "November 14, 2017"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(Hmisc)
library(ggthemes)
library(knitr)
library(xtable)
library(pander)
library(tidyr)
library(reshape2)
library(directlabels)
```

```{r}
#Bring data
WHR2015<-read_csv("~/Desktop/DA101/FinalProject/2015.csv")
WHR2016<-read_csv("~/Desktop/DA101/FinalProject/2016.csv")
WHR2017<-read_csv("~/Desktop/DA101/FinalProject/2017.csv")

```


#Introduction
  The World happiness reports are a series of surveys of the state of global happiness. The survey was started in 2012 and the report continuous for every year. In this project, we only focus on the newest three datasets which were from 2015 to 2017.  Each of the datasets contains more than 150 countries that across 10 different regions. The datasets also have happiness rank and happiness scores and other 6 factors that related to happiness score. Knowing the happiness score was calculated by the sum of the six-factor with the dystopia residual. The dystopia residual comes from the imaginary country that has the world’s least-happy people. The purpose for that is to have a benchmark against which all countries can be favorably compared. In this study, we will not focus on dystopia, but rather concentrate on the six factors. The world happiness report can work as a critical indicator for the government. Since they want to make their citizens feel happy and fulfilled. The peaceful and happy environment in the country will enhance political stability and keep making countries develop economically. By well using the world happiness score, and enhance, if all of the countries that involved in the report would take a serious consideration about what behinds the data itself and how to increase panel value, we will be able to make the world a better place. 
  During the data exploration part, we want to get a sense of how does the average happiness score of different region change through years, is the first ranked countries means the first ranked region, as well as how does each of the factor influence the happiness score for specific countries.  Other than that, we also want to see if the data of happiness score for three years have normal distributions so we can run the corresponding statistical analysis for them.  
  For the statistical analysis part, we want to find the best bivariate regression between the happiness score and factor, and also how does each of the variable associated with each other. 
For the statistical analysis part, we want to find the best bivariate regression between the happiness score and factor, and also if the happiness scores are normally distributed, is there a significant difference for means through the years.

#Ethical Consideration
  Happiness has a broad definition of all mankind. It’s the purpose of one’s life, it’s the meaning of existence, it’s the set of all positive emotions... People spend their whole life to find the source of the ethical obligation. In world happiness report dataset, the six factors that list as the causes for happiness contains comfort, social support, and personal well-being. Each of the factors was measured by a specific index, however, the index does not really reflect the real situation for some unique factor. Take the freedom as an example, the researcher used a number to represent people’s level of freedom, as we know freedom has a very philosophical definition, it’s hard to convince people to believe the rank of people’s freedom level. In addition, high happiness score only represents the country has valuable data for the six factors, the level of citizens fulfillment might cause by another variable as well. The existence of the confounds could influence the internal validity of the data, which means what the data claim to measure is not the same as what the data actually measure.  The world happiness report is beneficial to all governments of the countries that be involved for making policy decisions and also create a better and happier future for their residences. 


#Data Exploration 

```{r}
CONREG<-WHR2016%>%
  dplyr::select(Region, Country) 
WHR2017<-left_join(WHR2017,CONREG, by="Country")
WHR2017<-WHR2017[c(1,13,2,3,4,5,6,7,8,9,10,11,12)]

WHR2015<-WHR2015%>%
  mutate(Year=2015)
WHR2016<-WHR2016%>%
  mutate(Year=2016)
WHR2017<-WHR2017%>%
  mutate(Year=2017)

#Remove the error rows, which we are not interested with 
WHR2015<-WHR2015[-c(5)]
WHR2016<-WHR2016[-c(5,6)]
WHR2017<-WHR2017[-c(5,6)]

#Rename WHR2017's columns
WHR2017<-WHR2017 %>%
  dplyr::rename("Happiness Rank" ="Happiness.Rank")
WHR2017<-WHR2017 %>%
  dplyr::rename("Happiness Score"="Happiness.Score")
WHR2017<-WHR2017 %>%
  dplyr::rename("Economy (GDP per Capita)"="Economy..GDP.per.Capita.")
WHR2017<-WHR2017 %>%
  dplyr::rename("Health (Life Expectancy)"="Health..Life.Expectancy.")
WHR2017<-WHR2017 %>%
  dplyr::rename("Trust (Government Corruption)"="Trust..Government.Corruption.")
WHR2017<-WHR2017 %>%
  dplyr::rename("Dystopia Residual"="Dystopia.Residual")


WHR<- rbind(WHR2015,WHR2016,WHR2017)
WHR<-WHR%>%
  dplyr::rename("HappinessScore"="Happiness Score")
WHR<-WHR%>%
  dplyr::rename("HappinessRank"="Happiness Rank")
WHRSUM<-WHR %>%
  group_by(Region, Year)%>%
  dplyr::summarise(MeanHP=mean(suppressWarnings(as.numeric(HappinessScore))))
WHRSUM<-WHRSUM %>%
  filter(!is.na(MeanHP))
WHRSUM<-WHRSUM %>%
  filter(!is.na(Region))
```

```{r}
HighestHPS<-WHR %>%
  filter(HappinessRank==1)
HighestHPS<- HighestHPS %>%
  dplyr::select(Year, Country, HappinessRank,HappinessScore)


#summary(as.numeric(WHR2015$`Happiness Score`))
#summary(as.numeric(WHR2016$`Happiness Score`))
#summary(as.numeric(WHR2017$`Happiness.Score`))

LowestHPS0<-WHR %>%
  filter(HappinessRank==158,Year==2015)
LowestHPS1<-WHR %>%
  filter(HappinessRank==157,Year==2016)
LowestHPS2<-WHR %>%
  filter(HappinessRank==155,Year==2017)
LowestHPS<-rbind(LowestHPS0,LowestHPS1,LowestHPS2)
LowestHPS<-LowestHPS%>%
  dplyr::select(Year, Country, HappinessRank,HappinessScore)

  
```

After finishing this part of data wrangling, we filtered the extreme happiness rank for WHR, we can see the first ranked country in the year 2015 is Switzerland, which has the happiness score equal to 7.587. In 2016 is Denmark with happiness score equal to 7.526. In 2017 is Norway, it has happiness score equal to 7.537. As we see, the countries that won the first place all located in western Europe. 
And when it comes to the lowest rank countries 3 years. We see in the year 2015, Togo is the last country, which has the happiness score 2.839. In the year 2016, Burundi is the last country, the happiness score is 2.905; in the year 2017, Central African Republic is the lowest country, the happiness score for The Central African Republic is 2.693. All of the countries are located in Africa. We hypothesized that we should see a similar ranking for both countries as individual or region as a whole. So we expected to see the first place for the region is western Europe and the last ranked region is Sub-Saharan Africa.

#Data Visualization
```{r}
ggplot(WHRSUM,aes(Year,MeanHP,color=Region, group= Region))+
  geom_line()+
  labs(title = "Figure 1.1 Trends Of The Average Happiness Scores In Different Regions From 2015 to 2017", 
    y = "Avearage Happiness Scores", x = "Year", fill = "Region")+
  geom_dl(aes(label = Region), method = list(dl.combine("first.points", "last.points"), cex = 0.8))
```
To find out if the ranking of the region is the same as the ranking for countries. We grouped and summarize the data by region, and took an average for the happiness scores for countries that in each of the region. Then use a line graph to visualize the data. By using the graph, we can also see the trends of the happiness score change through years.
In Figure 1.1, the x-axis represents year while the y-axis represents the average happiness score. The different color of lines represents different regions.  For all of the regions, we see there is no significant change in the happiness score through years. Also, we see in the graph, Australia, and New Zealand region has the highest average happiness score through years. Western Europe remains the third place for happiness score across 3 years. And the region that ranked in the last place is sub-Saharan Africa. This is opposite with what we were expecting in the first place.


```{r}
ggplot(WHR, aes(suppressWarnings(as.numeric(WHR$HappinessScore))))+
  geom_histogram()+
  labs(title = "Figure 1.2 Histogram for World Happiness Score of Year 2015, 2016 and 2017 ", y = "Frequency", x="Happiness Scores")+
  facet_wrap(~Year)

```
Next, we made a histogram of happiness score count for the year 2015, 2016, and 2017, the purpose here is we want to see whether the data is normally distributed. From the graph, we see that most of the happiness score is normally distributed since they are all in the bell shape. By comparing the data from three years, we see that the year 2015 and year 2016 have the relatively condensed graph, in the year 2017, the happiness score about 5.2  has the highest counts. 

##Look at speical countries as individual
```{r}
China<-WHR %>%
  filter(Country=="China",Year==2017)
theUS<-WHR %>%
  filter(Country=="United States",Year==2017)
Switzerland<-WHR%>%
  filter(Country=="Switzerland",Year==2017)
Australia<-WHR%>%
  filter(Country=="Australia",Year==2017)
Egypt<-WHR%>%
  filter(Country=="Egypt",Year==2017)
Brazil<-WHR%>%
  filter(Country=="Brazil",Year==2017)

Regions<-rbind(China,theUS,Switzerland,Australia,Egypt,Brazil)
Regions<-as.data.frame(Regions)

Regions1<-melt(data= Regions, id.vars = c("Country","Region","HappinessRank","HappinessScore","Year","Dystopia Residual"))
Regions1<-dplyr::rename(Regions1, Scores=value,Factors=variable)

Regions1$Factors<-factor(Regions1$Factors, levels = c("Trust (Government Corruption)","Generosity", "Freedom","Health (Life Expectancy)","Economy (GDP per Capita)","Family"))

ggplot(data = Regions1, aes(x = Country, y = Scores, fill = factor(Factors))) + 
    geom_bar(stat = "identity")+
  coord_flip()+
  scale_fill_brewer(palette = 13)+
  labs(title = "Figure 1.3 Six Factors of the Happiness Score in 2017 of the Selected Countries ", y = "Happiness Score Without the Dystopia Residual", x="Country" ,fill = "Six Factors")
 
```
  In order to study which of the six variables has the greatest influence for happiness scores for each country, we made a stacked bar graph (Figure 1.3) with six factors of happiness score for some specific countries (United States, Switzerland, Egypt, China, Brazil, and Australia). The graph has the x-axis represents happiness score without a residual factor that was not included in the six-factor, and the y-axis represents countries, the different degree of purple color represents six factors that calculate happiness score. We can see that different factors have the different percentage for different countries. Both of family and GDP per capita took a great portion of the total amount. For most of the countries like China, United States, Switzerland, and Australia, GDP per capita plays the most important role in happiness score. For the country like Brazil, the family factor is obviously larger compares to GDP per capita. For most of the countries GDP per capita is the greatest part of the happiness score, but there are countries like Brazil. For Brazil, the family factor has the greatest influence towards the happiness score.

  During the data exploration phase, we made a few plots and solved some of the questions we had in the first place. According to figure 1.1's line plot, we can visualize stable trends for the average happiness scores of regions across three years. From figure 1.2, we are able to get an idea of how does the happiness scores of the countries are distributed for different years. And by viewing figure 1.3, we are able to conclude that family and GDP looks are the competitive candidate for the strongest factor of happiness score. 
  After all the data wrangling and visualization that we did in the data exploration phase, we would like to dig more into the statistical analysis. For figure 1.2, since all the graphs look have bell-shaped distribution, we would like to do a Shapiro-will test to see if the data for happiness score through the years follow a normal distribution. For figure 1.3, we would like to do the bivariate regression to see which one of the six factors have the greatest influence on the happiness score. 
Other than that, we also want to answer all other questions, for example, if the happiness scores are normally distributed, is there a significant difference for means through the years. We also want to know is there any relationship between the different variables and how do they related. 


#Statistical Analysis and Interpretation


```{r}
#Rename WHR columns
WHR<-WHR %>%
  dplyr::rename("GDPperCapita" ="Economy (GDP per Capita)")
WHR<-WHR %>%
  dplyr::rename("LifeExpectancy"="Health (Life Expectancy)")
WHR<-WHR %>%
  dplyr::rename("GovernmentCorruption"="Trust (Government Corruption)")
```



2.1 Bivariate Linear model for GDP per capita and happiness score 
```{r}
ModelGDP<-lm(formula=HappinessScore~GDPperCapita, data=WHR)
summary(ModelGDP)#R^2= 0.6169
ggplot(ModelGDP,aes(GDPperCapita,HappinessScore)) +
  geom_point()+
    geom_smooth(method = "lm", se=FALSE) +
  labs( title="Figure 2.1.1 Scatter plot for GDP per Capita with Happiness Score", x= "GDP per Capita", y="Happiness Score")
```
  First, we ran the liner model for all of the six-factor, we found out GDP per capita and family are the competitive candidates indeed. So we decided to plot the two factor with scatter plot, then comparing them in details.
The statistical result for GDP per capita vs. happiness score suggests that 61.61% (Adjusted R-squared= 0.6161) of the variance in the data is due to this bivariate regression. Since the degree of freedom is 468, it suggests a large enough sample size draw statistical analysis with. And the p-value for r square is less than 2.2e-16 which means we reject the null hypothesis by saying there is a significant positive linear relationship between the independent variable (GDP per capita) and the dependent variable (Happiness score).For every 1 unit increase in GDP per Capita, the Happiness score goes up by 2.14892 unit.
  Figure 2.1 shows a bivariate regression illustrates the linear association between happiness score and GDP per capita, and also explains how does a slight change in GDP per capita would affect the happiness score. According to the scatter plot, we see there is a strong positive relationship between GDP per capita and happiness score.

```{r}
ModelFamily<-lm(formula=HappinessScore~Family, data=WHR)
summary(ModelFamily)#R^2=0.4039
ggplot(ModelFamily,aes(Family,HappinessScore)) +
  geom_point()+
    geom_smooth(method = "lm", se=FALSE) +
  labs( title="Figure 2.1.2 Scatter plot for family with Happiness Score", x= "Family", y="Happiness Score")
```
The second statistical result is for family vs. happiness score, it suggests that 40.39% (Adjusted R-squared= 0.4039) of the variance in the data is due to this bivariate regression. Since the degree of freedom is 468, it suggests a large enough sample size to draw statistical analysis with. And the p-value for r square is less than 2.2e-16 which means we reject the null hypothesis by saying there is a significant positive linear relationship between the independent variable (Family) and the dependent variable (Happiness score). For every 1 unit increase in the family variable, the Happiness score goes up by 2.2708 unit.
Figure 2.2 shows a bivariate regression illustrates the positive linear association between the independent variable (Family) and the dependent variable (happiness score) and also explains how does a slight change in family would affect the happiness score.
By comparing the two bivariate regression graph above, we can clearly see figure 2.1 has a stronger positive linear association than the figure 2.2, since the dots in the previous graph are more condensed towards the best fit line. 


2.2 Resisdual Plot for GDP per capia
```{r}
RPGDP<- WHR%>%
  mutate(resid=resid(ModelGDP))
plot(RPGDP$GDPperCapita, RPGDP$resid, xlab = "GDP per Capita", ylab = "the Residuals of GDP per capita")%>%
  abline(0,0)%>%
  title(main="Figure 2.2 Residualplots for GDP per Capita")
```
We want to make sure if the linear model is the best model to represent the relationship between GDP per capita and happiness score, so we plot a residual plot for it.
Figure 2.2 shows a residual plot for GDP per capita. The x-axis represents the GDP per capita from 0.0 to about 2.0, residuals of GDP per capita shows on the vertical axis. According to the residual plot, we see the points are randomly dispersed around the horizontal axis, the linear regression model is appropriate for the data. 
So according to the linear model and the residual plot, we can conclude that the GDP per capita has the strongest influence on Happiness scores through the whole three years.




2.3 Test for normal distribution
```{r}
shapiro.test(WHR2017$`Happiness Score`)
shapiro.test(WHR2016$`Happiness Score`)
shapiro.test(WHR2015$`Happiness Score`)
```
  The next question we want to answer is, is the happiness score normally distributed through three years?
By using the Shapiro-Wilk test for three different years of the happiness score, we find out that the p-value for happiness score in the year 2015 is 0.01878, the year 2016 is 0.01248. For these two years, we fail to reject the null hypothesis by saying the data of happiness scores does not the normal distribution. But for the year 2017, we observed a p-value which is 0.05223. Our significance level was initially set at 0.05. Since it is greater than 0.05, we fail to reject the null hypothesis by saying there is a normal distribution for happiness score in the year 2017.

2.4 One sample t-test
```{r}
summary(WHR2016$`Happiness Score`)
t.test(WHR2017$`Happiness Score`,mu=5.382,var.equal=TRUE)
```

  Since only the year 2017's happiness scores have normal distribution, we can only do the one sample t-test on it. By using the roughly calculated mean score from 2016 (mean= 5.382), we compare the mean distribution of happiness score in 2017 to see if there is a significant difference happened for mean in 2017. According to the t-test result, the null hypothesis is the true mean is equal to 5.382, which says that the mean happiness score for 2017 has no different than then 5.382. We fail the null hypothesis by saying there is no significant difference between the mean score in 2017 with 5.382. (one sample t-test, p-value=2.129e-12). The degree of freedom is 154, it suggests that we have enough population to draw the conclusion. With the 95% confidence interval, we are 95% sure the population means is between 0.558 to 5.174521 to 5.533517.
  According to the statistical result, we have to admit that we didn't find a significant change for happiness score in 2017 by comparing with the mean data for 2016.
 

2.5 Corrlation test
```{r}
WHR<-WHR %>%
  mutate(Family=as.numeric(c(Family)), GDPperCapita=as.numeric(c(WHR$GDPperCapita)), LifeExpectancy=as.numeric(c(WHR$LifeExpectancy)),Freedom=as.numeric(Freedom),GovernmentCorruption=as.numeric(WHR$GovernmentCorruption), Generosity=as.numeric(Generosity))
#Remove the repeated colunms and the residual columns.
#WHR<-WHR[-c(5,7,9,11)]

cor.test(WHR$GDPperCapita,WHR$LifeExpectancy)#p-value = 2.2e-16 cor=0.792224 
ggplot(WHR,aes(GDPperCapita, LifeExpectancy)) +
  geom_point()+
    geom_smooth(method = "lm", se=FALSE) +
  labs( title="2.5 Scatter plot for GDP per Capita with Life Expectancy Index", x= "GDP per Capita", y="Life Expectancy Index")


```

Then, we wonder if there any relationship between the different variables and how do they related. We ran the correlation test for all different pairs of variables, and we find out that GDP per capita vs. life expectancy has the best correlation we can ever find. 
According to the statistical result of the correlation test of GDP per capita vs. Life expectancy index, I can conclude that there is a strong correlation between the two variables. (GDP per capita vs. Life expectancy)(correlation test p-value < 2.2e-16) I reject the null hypothesis by saying there is a strong positive relationship which has correlation coefficient equals to 0.792224. With the 95% confidence interval, we are 95% sure the true correlation coefficient is between 0.7559430 to 0.8236532.
  Figure 2.5 shows the correlation between the factor GDP per Capita with Life Expectancy Index, as shown in the graph, GDP per capita was represented on the horizontal axis while life expectancy index was represented on the vertical axis. Since the points are close to the best fit line, the graph suggests a strong positive relationship between the two variables.
```{r}
#Family vs. the others
cor.test(WHR$Family,WHR$LifeExpectancy)
cor.test(WHR$Family,WHR$Freedom)
cor.test(WHR$Family,WHR$GovernmentCorruption)#p-value = 0.0005581 cor=0.1586046
cor.test(WHR$Family,WHR$Generosity)#p-value = 0.1202 cor=0.07177475 

#Life expectancy vs. the others
cor.test(WHR$LifeExpectancy,WHR$Freedom)
cor.test(WHR$LifeExpectancy,WHR$GovernmentCorruption)
cor.test(WHR$LifeExpectancy,WHR$Generosity) ###p-value = 0.09404 cor=0.07732636 

#Freedom vs. the others
cor.test(WHR$Freedom,WHR$GovernmentCorruption)
cor.test(WHR$Freedom,WHR$Generosity)

#Government Corruption vs. the others
cor.test(WHR$GovernmentCorruption,WHR$Generosity)

#Income vs. generosity
cor.test(WHR$GDPperCapita,WHR$Generosity)

```
  We also did the correlation test for each of the variables, and we figured they all related to each other in some degrees, except generosity with income, health, and family. The p-value is all greater than 0.05 (Income&Generosity,p=0.7593; Health&Generosity, p=0.09404; Family&Generosity,p=0.1202) so we fail to reject the null hypothesis by saying there is no significant relationship found in between the variables.

2.5 multiple regression 
  Since we already knew that GDP per capita is highly correlated with life expectancy, we wonder if the interaction between this two variable could lead to a better linear regression. 
```{r}
ModelGDPLife<-lm(formula=HappinessScore~GDPperCapita+LifeExpectancy, data=WHR)
summary(ModelGDPLife)
```
  The statistical result suggests that 65.94% (Adjusted R-squared= 0.6594) of the variance in the data is due to this Bivariate Regression.The degree of freedom equals to 467, which is large so we have enough sample size. And the p-value for r square is less than 2.2e-16, which suggests us to reject the null hypothesis by saying there is a significant linear relationship between the independent variable (GDP per capita and life expectancy) and the dependent variable (Happiness score). Because of the interaction of the two independent variables, for every 1 unit increase in the Economy (GDP per Capita) and Health (Life Expectancy), the Happiness score goes up by 1.41676 unit,and for every 1 unit increase in Health (Life Expectancy), the Happiness score goes up by 1.59923 unit.
By comparing the r square value in this model with the bivariate regression model with the only GDP per capita, we see the bivariate regression model has a better r square value, it suggests that the joining of the second independent variable decreased the linear relationship between the independent variable and the dependent variable. So we would better stick with the GDP per capita and say it is the best predictor of happiness score.

#Conclusion
  In the data exploration part, we visualized the graph for three year's happiness score across the different region, and it tells us that it looks there is no significant change in happiness score through the years and the first ranked countries does not mean it located in the first ranked region. Then, we observed the distribution for happiness score across three different years and wondering if it really means normal distribution. Finally, we use the stacked bar graph to visualize which factor contributed the most to the happiness score, we found out that for most of the countries that we selected, income (which were measured by GDP per capita) means the most towards their happiness score, but for a few portion of the countries, the family also plays a critical role. 
  To found out the question we left in the exploration phase, we did the statistical analysis part. According to the bivariate regression model, we found out that GDP per capita plays the most important role in generating the happiness score. And only the happiness score in the year 2017 has the normal distribution, by doing the one sample t-test, we figured that there is no significant different between the mean score in 2016 with 2017. After that, we also did a correlation test to see if the six factors have correlation with each other. The greatest correlation was found in income with health. And when running the correlation test for other factors, we see they all related to each other in some degrees, except generosity with family, health, and income. Because a strong correlation was found in income with health, we wonder if the interaction for this two variable could result in a better linear regression. However, the new r square value is less than the one we observed in the model by GDP with happiness score. So the multi-regression didn't make the things become better.
  The most important take-home message we learned in this project is happiness score was measured primarily based on GDP per capita when we look the 150 countries' three year report as a whole, it implies that if the government wants to make their people better off, the first thing they need to take care with is finding a way to increase their GDP per capita. Also, since the happiness score hasn't changed that much through the years, it might because the countries that involved in this report didn't take it seriously. Knowing if the countries would take a deeper analysis of this report, they might be able to find out which part they miss in the happiness score. By finding a way to fix it, their residence would expect to live a better life in the future. 
  We also can see there is a lot of limitations in this report, first, we still lack the sample size, if we can analyze the world happiness report for 10 years datasets, we might able to find other interesting things. Second, as we mentioned before, because some of the variables is not reasonable to be analyzed by quantitative data, the representation for some of the variable might not accurate. In other words, the number we have here might not really measure the factor that it claimed to measure, in this case, we might have a low internal validity.
  We discovered that there are many other factors that can actually affect people's happiness besides all of those 6 factors. So for the future analysis recommandation, we suggest to found other factor that could affect people's fullfillment level and see if it has any relationship with happiness score. For example, the environment is a pretty important factor that can affect people's happiness. From my own perspective, the air pollution and water pollution in China(my home country) are much more serious compares to here in America. Most of the time, I refuse to go outside of my home since the air outside is the stimulus and smelly. However, in America, I am more willing to go outside and walking around, this helps to feel better to be in such an environment. This does not only affect me, but also other people all over this world. There is another example of the variables that may make people feel happy is religion. In many areas, people took a part in the religious practices and some areas are not. We think people who have faith will live happier compares to those people who are nonreligious. This does make sense because religious people can always get solutions for their daily problems from religion, and for nonreligious people, it is harder for them to get comfort from religion, so it will be easier for them to feel sad and disappointed.